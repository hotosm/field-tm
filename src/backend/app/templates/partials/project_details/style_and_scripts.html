<script>
    (function() {
      const projectId = {% if project %}{{ project.id }}{% else %}null{% endif %};
      if (!projectId) return;

      // Shared setup preference for streamlined defaults across steps.
      const setupPreferenceKey = `ftm-project-setup-preference-${projectId}`;
      const hasXlsform = {{ 'true' if has_xlsform else 'false' }};
      const OSM_FORM_TITLE_TO_PRESET = {
        'OSM Buildings': { category: 'buildings', geomType: 'POLYGON', centroid: false },
        'OSM Highways': { category: 'highways', geomType: 'POLYLINE', centroid: false },
        'OSM Healthcare': { category: 'health', geomType: 'POINT', centroid: false },
        'OSM Toilets': { category: 'toilets', geomType: 'POINT', centroid: false },
        'OSM Religious': { category: 'religious', geomType: 'POINT', centroid: false },
        'OSM Landuse': { category: 'landusage', geomType: 'POLYGON', centroid: false },
        'OSM Waterways': { category: 'waterways', geomType: 'POLYLINE', centroid: false },
        'OSM Water Points': { category: 'waterpoints', geomType: 'POINT', centroid: false },
        'OSM Waste Disposal': { category: 'wastedisposal', geomType: 'POINT', centroid: false },
        'OSM Education': { category: 'education', geomType: 'POINT', centroid: false },
        'OSM Cemeteries': { category: 'cemeteries', geomType: 'POLYGON', centroid: false },
        'OSM Amenities': { category: 'amenities', geomType: 'POINT', centroid: false },
      };

      function defaultDownloadPreset() {
        return { category: 'buildings', geomType: 'POLYGON', centroid: false };
      }

      function presetForFormTitle(formTitle) {
        return OSM_FORM_TITLE_TO_PRESET[formTitle] || defaultDownloadPreset();
      }

      function parseSetupPreference() {
        try {
          const raw = window.localStorage.getItem(setupPreferenceKey);
          return raw ? JSON.parse(raw) : null;
        } catch (_) {
          return null;
        }
      }

      function saveSetupPreference(preference) {
        try {
          window.localStorage.setItem(setupPreferenceKey, JSON.stringify(preference));
        } catch (_) {
          // Ignore storage failures to keep setup flow resilient.
        }
      }

      function bindAdvancedToggle(toggleElement, panelElement) {
        if (!toggleElement || !panelElement) return;
        toggleElement.addEventListener('click', function() {
          panelElement.classList.toggle('ftm-advanced-config--hidden');
        });
      }

      // Step 1: XLSForm Selection
      const uploadXlsformBtn = document.getElementById('upload-xlsform-btn');
      const formAdvancedConfigToggle = document.getElementById('form-advanced-config-toggle');
      const formAdvancedConfigPanel = document.getElementById('form-advanced-config-panel');
      const uploadXlsformForm = document.getElementById('upload-xlsform-form');
      const uploadXlsformSubmitBtn = document.getElementById('upload-xlsform-submit-btn');
      const selectedXlsformName = document.getElementById('selected-xlsform-name');
      const xlsformFileInput = document.getElementById('xlsform-file-input');
      const xlsformSelect = document.getElementById('xlsform-select');
      const xlsformStatus = document.getElementById('xlsform-status');
      const templateFormIdInput = document.getElementById('template-form-id');
      const formTemplatesById = new Map();

      bindAdvancedToggle(formAdvancedConfigToggle, formAdvancedConfigPanel);

      function setStep1Status(message, variant = 'info') {
        if (!xlsformStatus) return;
        xlsformStatus.innerHTML = `<wa-callout variant="${variant}"><span>${message}</span></wa-callout>`;
      }

      function setStep1Ready(isReady) {
        if (!uploadXlsformSubmitBtn) return;
        uploadXlsformSubmitBtn.disabled = !isReady;
      }

      function clearTemplateSelection() {
        if (templateFormIdInput) {
          templateFormIdInput.value = '';
        }
      }

      function setSurveyTypeOptions(forms) {
        if (!xlsformSelect) return;
        xlsformSelect.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a survey type...';
        xlsformSelect.appendChild(placeholder);

        forms.forEach((form) => {
          const option = document.createElement('option');
          option.value = String(form.id);
          option.textContent = form.title;
          xlsformSelect.appendChild(option);
        });
      }

      async function loadSurveyTypes() {
        if (!xlsformSelect) return;
        xlsformSelect.disabled = true;
        xlsformSelect.innerHTML = '<option value="">Loading survey types...</option>';

        try {
          const response = await fetch('/central/list-forms');
          if (!response.ok) {
            throw new Error('Failed to load forms');
          }

          const forms = await response.json();
          formTemplatesById.clear();
          forms.forEach((form) => formTemplatesById.set(String(form.id), form));

          if (forms.length === 0) {
            xlsformSelect.innerHTML = '<option value="">No survey types available</option>';
            setStep1Status(
              'No survey forms are available. Upload a custom form in Advanced Config.',
              'warning',
            );
            return;
          }

          setSurveyTypeOptions(forms);
          xlsformSelect.disabled = false;
          setStep1Status(
            'Select a survey type, or upload a custom form in Advanced Config.',
            'info',
          );
        } catch (error) {
          xlsformSelect.innerHTML = '<option value="">Failed to load survey types</option>';
          setStep1Status(`Error loading forms: ${error.message}`, 'danger');
        }
      }

      if (!hasXlsform) {
        setStep1Ready(false);
        loadSurveyTypes();
      }

      if (xlsformSelect && !hasXlsform) {
        xlsformSelect.addEventListener('change', function() {
          const formId = xlsformSelect.value;
          if (!formId) {
            clearTemplateSelection();
            setStep1Ready(false);
            return;
          }

          if (templateFormIdInput) {
            templateFormIdInput.value = formId;
          }
          if (xlsformFileInput) {
            xlsformFileInput.value = '';
          }
          if (selectedXlsformName) {
            selectedXlsformName.textContent = '';
          }

          const selectedForm = formTemplatesById.get(String(formId));
          const preset = presetForFormTitle(selectedForm?.title);
          saveSetupPreference({
            mode: 'template',
            templateFormId: formId,
            templateTitle: selectedForm?.title || null,
            category: preset.category,
            geomType: preset.geomType,
            centroid: preset.centroid,
          });

          setStep1Ready(true);
          setStep1Status('Survey type selected. Click "Continue".', 'info');
        });
      }

      // Handle custom XLSForm uploads from advanced config
      if (uploadXlsformBtn && xlsformFileInput && !hasXlsform) {
        uploadXlsformBtn.addEventListener('click', () => {
          xlsformFileInput.click();
        });

        xlsformFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;

          const validExtensions = ['.xls', '.xlsx'];
          const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
          if (!validExtensions.includes(fileExtension)) {
            setStep1Status('Invalid file type. Please upload a .xls or .xlsx file.', 'danger');
            xlsformFileInput.value = '';
            setStep1Ready(false);
            return;
          }

          clearTemplateSelection();
          if (xlsformSelect) {
            xlsformSelect.value = '';
          }
          if (selectedXlsformName) {
            selectedXlsformName.textContent = `Selected file: ${file.name}`;
          }

          saveSetupPreference({
            mode: 'custom',
            templateFormId: null,
            templateTitle: null,
            category: 'buildings',
            geomType: 'POLYGON',
            centroid: false,
          });

          setStep1Ready(true);
          setStep1Status(
            'Custom form selected. Click "Continue" to upload it.',
            'info',
          );
        });
      }

      if (uploadXlsformForm && !hasXlsform) {
        uploadXlsformForm.addEventListener('submit', function(e) {
          const hasTemplateSelection = Boolean(templateFormIdInput?.value);
          const hasUploadedFile = Boolean(xlsformFileInput?.files?.length);

          if (!hasTemplateSelection && !hasUploadedFile) {
            e.preventDefault();
            setStep1Status(
              'Choose a survey type first, or upload a custom form in Advanced Config.',
              'warning',
            );
            setStep1Ready(false);
            return false;
          }
        });
      }

      // Step 2: OSM Data
      const downloadOsmDataBtn = document.getElementById('download-osm-data-btn');
      const collectNewDataBtn = document.getElementById('collect-new-data-btn');
      const uploadGeojsonBtn = document.getElementById('upload-geojson-btn');
      const geojsonFileInput = document.getElementById('geojson-file-input');
      const osmDataStatus = document.getElementById('osm-data-status');
      const downloadLoading = document.getElementById('download-loading');
      const downloadBtnText = document.getElementById('download-btn-text');
      const downloadSpinner = document.getElementById('download-spinner');
      const dataAdvancedConfigToggle = document.getElementById('data-advanced-config-toggle');
      const dataAdvancedConfigPanel = document.getElementById('data-advanced-config-panel');
      const recommendedDataNoteText = document.getElementById('recommended-data-note-text');
      const osmCategorySelect = document.getElementById('osm-category-select');
      const osmGeomTypeSelect = document.getElementById('osm-geom-type-select');
      const osmCentroidCheckbox = document.getElementById('osm-centroid-checkbox');

      bindAdvancedToggle(dataAdvancedConfigToggle, dataAdvancedConfigPanel);

      function formatGeomType(geomType) {
        if (geomType === 'POLYGON') return 'polygons';
        if (geomType === 'POLYLINE') return 'polylines';
        if (geomType === 'POINT') return 'points';
        return 'features';
      }

      function toFormTitle(category) {
        return Object.keys(OSM_FORM_TITLE_TO_PRESET).find(
          (title) => OSM_FORM_TITLE_TO_PRESET[title]?.category === category,
        );
      }

      function buildDownloadUrl(config) {
        const params = new URLSearchParams({
          project_id: String(projectId),
          osm_category: config.category || 'buildings',
          geom_type: config.geomType || 'POLYGON',
        });
        if (config.centroid) {
          params.set('centroid', 'true');
        }
        return `/download-osm-data-htmx?${params.toString()}`;
      }

      function readStep2DownloadConfig() {
        return {
          category: osmCategorySelect?.value || 'buildings',
          geomType: osmGeomTypeSelect?.value || 'POLYGON',
          centroid: Boolean(osmCentroidCheckbox?.checked),
        };
      }

      function applyStep2DownloadConfig(config, sourceMode = 'template') {
        if (osmCategorySelect) osmCategorySelect.value = config.category || 'buildings';
        if (osmGeomTypeSelect) osmGeomTypeSelect.value = config.geomType || 'POLYGON';
        if (osmCentroidCheckbox) osmCentroidCheckbox.checked = Boolean(config.centroid);

        if (downloadOsmDataBtn) {
          downloadOsmDataBtn.setAttribute('hx-post', buildDownloadUrl(config));
        }

        if (!recommendedDataNoteText) return;

        const title = toFormTitle(config.category);
        const geomLabel = formatGeomType(config.geomType);
        if (sourceMode === 'custom') {
          recommendedDataNoteText.textContent = (
            'You uploaded a custom form, so this OSM download is optional. '
            + 'Use Advanced Config to upload your own GeoJSON or adjust download settings.'
          );
        } else if (title) {
          recommendedDataNoteText.textContent = `Recommended source: ${title} (${geomLabel}). Review the data on the map, then continue.`;
        } else {
          recommendedDataNoteText.textContent = `Recommended source updated (${geomLabel}). Review the data on the map, then continue.`;
        }
      }

      if (!hasXlsform && downloadOsmDataBtn) {
        downloadOsmDataBtn.disabled = true;
      }
      if (!hasXlsform && collectNewDataBtn) {
        collectNewDataBtn.disabled = true;
      }
      if (!hasXlsform && uploadGeojsonBtn) {
        uploadGeojsonBtn.disabled = true;
      }

      if (downloadOsmDataBtn) {
        const preference = parseSetupPreference();
        if (preference && preference.category && preference.geomType) {
          applyStep2DownloadConfig(
            {
              category: preference.category,
              geomType: preference.geomType,
              centroid: Boolean(preference.centroid),
            },
            preference.mode === 'custom' ? 'custom' : 'template',
          );
        } else {
          applyStep2DownloadConfig(defaultDownloadPreset(), 'template');
        }

        downloadOsmDataBtn.addEventListener('htmx:before-request', function() {
          if (downloadLoading) downloadLoading.style.display = 'block';
          if (downloadBtnText) downloadBtnText.textContent = 'Downloading...';
          if (downloadSpinner) downloadSpinner.style.display = 'inline-block';
          downloadOsmDataBtn.disabled = true;
        });

        downloadOsmDataBtn.addEventListener('htmx:after-request', function() {
          if (downloadLoading) downloadLoading.style.display = 'none';
          if (downloadBtnText) downloadBtnText.textContent = 'Download OSM Data';
          if (downloadSpinner) downloadSpinner.style.display = 'none';
          downloadOsmDataBtn.disabled = false;
        });
      }

      if (osmCategorySelect || osmGeomTypeSelect || osmCentroidCheckbox) {
        const onAdvancedDownloadConfigChange = function() {
          const previous = parseSetupPreference() || {};
          const sourceMode = previous.mode === 'custom' ? 'custom' : 'template';
          const config = readStep2DownloadConfig();
          applyStep2DownloadConfig(config, sourceMode);
          saveSetupPreference({
            ...previous,
            mode: sourceMode,
            category: config.category,
            geomType: config.geomType,
            centroid: config.centroid,
          });
        };

        if (osmCategorySelect) {
          osmCategorySelect.addEventListener('change', onAdvancedDownloadConfigChange);
        }
        if (osmGeomTypeSelect) {
          osmGeomTypeSelect.addEventListener('change', onAdvancedDownloadConfigChange);
        }
        if (osmCentroidCheckbox) {
          osmCentroidCheckbox.addEventListener('change', onAdvancedDownloadConfigChange);
        }
      }

      // Upload custom GeoJSON
      const uploadGeojsonForm = document.getElementById('upload-geojson-form');

      if (uploadGeojsonBtn) {
        uploadGeojsonBtn.addEventListener('click', () => {
          if (geojsonFileInput) {
            geojsonFileInput.click();
          }
        });
      }

      if (geojsonFileInput && uploadGeojsonForm) {
        geojsonFileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (!file) return;

          const validExtensions = ['.geojson', '.json'];
          const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
          if (!validExtensions.includes(fileExtension)) {
            osmDataStatus.innerHTML = '<wa-callout variant="danger"><span>Invalid file type. Please upload a .geojson or .json file.</span></wa-callout>';
            geojsonFileInput.value = '';
            return;
          }

          if (uploadGeojsonForm.requestSubmit) {
            uploadGeojsonForm.requestSubmit();
          } else {
            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
            uploadGeojsonForm.dispatchEvent(submitEvent);
          }
        });
      }

  // Step 2: Data extract preview (collapsed by default when Step 2 is complete)
  const previewDataExtractBtn = document.getElementById('preview-data-extract-btn');
  const hideDataExtractPreviewBtn = document.getElementById('hide-data-extract-preview-btn');
  const geojsonPreviewWrapper = document.getElementById('geojson-preview-wrapper');
  const geojsonPreviewContainer = document.getElementById('geojson-preview-container');

  if (previewDataExtractBtn && geojsonPreviewWrapper) {
    previewDataExtractBtn.addEventListener('click', () => {
      geojsonPreviewWrapper.style.display = 'block';
      if (hideDataExtractPreviewBtn) hideDataExtractPreviewBtn.style.display = 'inline-flex';
    });
  }

  if (hideDataExtractPreviewBtn && geojsonPreviewWrapper && geojsonPreviewContainer) {
    hideDataExtractPreviewBtn.addEventListener('click', () => {
      geojsonPreviewWrapper.style.display = 'none';
      hideDataExtractPreviewBtn.style.display = 'none';
      geojsonPreviewContainer.innerHTML = '';
    });
  }

  // Step 3: Split AOI - Handle algorithm selection and parameter visibility
  const splitAlgorithm = document.getElementById('split-algorithm');
  const paramBuildings = document.getElementById('param-buildings');
  const paramDimension = document.getElementById('param-dimension');
  const noOfBuildingsInput = document.getElementById('no-of-buildings');
  const dimensionMetersInput = document.getElementById('dimension-meters');
  const splitAdvancedConfigToggle = document.getElementById('split-advanced-config-toggle');
  const splitAdvancedConfigPanel = document.getElementById('split-advanced-config-panel');
  const splitIncludeRoadsCheckbox = document.getElementById('split-include-roads-checkbox');
  const splitIncludeRiversCheckbox = document.getElementById('split-include-rivers-checkbox');
  const splitIncludeRailwaysCheckbox = document.getElementById('split-include-railways-checkbox');
  const splitIncludeAerowaysCheckbox = document.getElementById('split-include-aeroways-checkbox');
  const splitIncludeRoadsValue = document.getElementById('split-include-roads-value');
  const splitIncludeRiversValue = document.getElementById('split-include-rivers-value');
  const splitIncludeRailwaysValue = document.getElementById('split-include-railways-value');
  const splitIncludeAerowaysValue = document.getElementById('split-include-aeroways-value');

  bindAdvancedToggle(splitAdvancedConfigToggle, splitAdvancedConfigPanel);

  function syncSplitLinearFeatureOptions() {
    if (splitIncludeRoadsValue && splitIncludeRoadsCheckbox) {
      splitIncludeRoadsValue.value = splitIncludeRoadsCheckbox.checked ? 'true' : 'false';
    }
    if (splitIncludeRiversValue && splitIncludeRiversCheckbox) {
      splitIncludeRiversValue.value = splitIncludeRiversCheckbox.checked ? 'true' : 'false';
    }
    if (splitIncludeRailwaysValue && splitIncludeRailwaysCheckbox) {
      splitIncludeRailwaysValue.value = splitIncludeRailwaysCheckbox.checked ? 'true' : 'false';
    }
    if (splitIncludeAerowaysValue && splitIncludeAerowaysCheckbox) {
      splitIncludeAerowaysValue.value = splitIncludeAerowaysCheckbox.checked ? 'true' : 'false';
    }
  }

  [splitIncludeRoadsCheckbox, splitIncludeRiversCheckbox, splitIncludeRailwaysCheckbox, splitIncludeAerowaysCheckbox]
    .filter(Boolean)
    .forEach((checkbox) => {
      checkbox.addEventListener('change', syncSplitLinearFeatureOptions);
    });
  syncSplitLinearFeatureOptions();

  if (splitAlgorithm) {
    // Function to update parameter visibility
    function updateParameterVisibility() {
      const algorithm = splitAlgorithm.value;
      if (algorithm === 'DIVIDE_BY_SQUARE') {
        if (paramBuildings) paramBuildings.style.display = 'none';
        if (paramDimension) paramDimension.style.display = 'block';
        if (noOfBuildingsInput) {
          noOfBuildingsInput.removeAttribute('required');
          noOfBuildingsInput.disabled = true; // Disable so it's not sent
        }
        if (dimensionMetersInput) {
          dimensionMetersInput.setAttribute('required', 'required');
          dimensionMetersInput.disabled = false;
        }
      } else if (algorithm === 'AVG_BUILDING_VORONOI' || algorithm === 'AVG_BUILDING_SKELETON') {
        if (paramBuildings) paramBuildings.style.display = 'block';
        if (paramDimension) paramDimension.style.display = 'none';
        if (noOfBuildingsInput) {
          noOfBuildingsInput.setAttribute('required', 'required');
          noOfBuildingsInput.disabled = false;
        }
        if (dimensionMetersInput) {
          dimensionMetersInput.removeAttribute('required');
          dimensionMetersInput.disabled = true; // Disable so it's not sent
        }
      } else {
        // NO_SPLITTING, TOTAL_TASKS, or other options
        if (paramBuildings) paramBuildings.style.display = 'none';
        if (paramDimension) paramDimension.style.display = 'none';
        if (noOfBuildingsInput) {
          noOfBuildingsInput.removeAttribute('required');
          noOfBuildingsInput.disabled = true; // Disable so it's not sent
        }
        if (dimensionMetersInput) {
          dimensionMetersInput.removeAttribute('required');
          dimensionMetersInput.disabled = true; // Disable so it's not sent
        }
      }
    }

    // Initialize visibility on page load
    updateParameterVisibility();

    // Update on change
    splitAlgorithm.addEventListener('change', updateParameterVisibility);
  }

  // Scroll to map after successful split
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'split-status') {
      // Check if split was successful (contains success message)
      const content = event.detail.target.innerHTML;
      if (content.includes('split successfully') || content.includes('Generated')) {
        // Scroll to the map preview after a short delay to allow map to render
        setTimeout(function() {
          const mapContainer = document.getElementById('leaflet-map-split-preview');
          if (mapContainer) {
            mapContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else {
            // Fallback: scroll to split-status container
            event.detail.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 500);
      }
    }
  });

  // Handle form submission and HTMX events
  const splitAoiForm = document.getElementById('split-aoi-form');
  if (splitAoiForm) {
    // Function to update UI based on algorithm selection
    function updateAlgorithmUI() {
      const algorithm = splitAlgorithm?.value;
      const paramContainer = document.getElementById('algorithm-param-container');
      const splitBtn = splitAoiForm.querySelector('button[type="submit"]');
      const splitBtnText = document.getElementById('split-btn-text');

      // Show/hide parameter container based on algorithm
      if (paramContainer) {
        if (algorithm === 'NO_SPLITTING' || !algorithm) {
          paramContainer.style.display = 'none';
        } else {
          paramContainer.style.display = 'block';
        }
      }

      // Update button text based on algorithm and current state
      if (splitBtnText) {
        if (algorithm === 'NO_SPLITTING') {
          splitBtnText.textContent = 'Confirm No Splitting';
        } else if (algorithm === 'DIVIDE_BY_SQUARE') {
          splitBtnText.textContent = 'Split by Square';
        } else if (algorithm === 'AVG_BUILDING_VORONOI' || algorithm === 'AVG_BUILDING_SKELETON') {
          splitBtnText.textContent = 'Split by Buildings';
        } else if (algorithm && algorithm !== '') {
          splitBtnText.textContent = 'Split AOI';
        } else {
          splitBtnText.textContent = 'Select Option';
        }
      }

      // Disable/enable button based on selection
      if (splitBtn) {
        splitBtn.disabled = !algorithm || algorithm === '';
      }

      // Disable the parameter that's not needed so it's not sent in form data
      if (algorithm === 'DIVIDE_BY_SQUARE') {
        if (noOfBuildingsInput) {
          noOfBuildingsInput.disabled = true;
        }
        if (dimensionMetersInput) {
          dimensionMetersInput.disabled = false;
        }
      } else if (algorithm === 'AVG_BUILDING_VORONOI' || algorithm === 'AVG_BUILDING_SKELETON') {
        if (dimensionMetersInput) {
          dimensionMetersInput.disabled = true;
        }
        if (noOfBuildingsInput) {
          noOfBuildingsInput.disabled = false;
        }
      } else if (algorithm === 'NO_SPLITTING' || !algorithm) {
        if (noOfBuildingsInput) {
          noOfBuildingsInput.disabled = true;
        }
        if (dimensionMetersInput) {
          dimensionMetersInput.disabled = true;
        }
      }
    }

    // Update UI on algorithm change
    if (splitAlgorithm) {
      splitAlgorithm.addEventListener('change', updateAlgorithmUI);
      // Initialize UI on page load
      updateAlgorithmUI();
    }

    // Handle form submission - ensure correct parameter is sent
    splitAoiForm.addEventListener('submit', function(e) {
      syncSplitLinearFeatureOptions();
      const algorithm = splitAlgorithm?.value;

      if (!algorithm || algorithm === '') {
        e.preventDefault();
        return false;
      }
    });

    // Show loading spinner on form submission
    splitAoiForm.addEventListener('htmx:beforeRequest', function() {
      const splitLoading = document.getElementById('split-loading');
      const splitBtnText = document.getElementById('split-btn-text');
      const splitBtnSpinner = document.getElementById('split-btn-spinner');
      if (splitLoading) splitLoading.style.display = 'block';
      const algorithm = splitAlgorithm?.value;
      if (splitBtnText) {
        if (algorithm === 'NO_SPLITTING') {
          splitBtnText.textContent = 'Confirming...';
        } else {
          splitBtnText.textContent = 'Splitting...';
        }
      }
      if (splitBtnSpinner) splitBtnSpinner.style.display = 'inline-block';
    });

    splitAoiForm.addEventListener('htmx:afterRequest', function(event) {
      const splitLoading = document.getElementById('split-loading');
      const splitBtnText = document.getElementById('split-btn-text');
      const splitBtnSpinner = document.getElementById('split-btn-spinner');
      if (splitLoading) splitLoading.style.display = 'none';
      if (splitBtnSpinner) splitBtnSpinner.style.display = 'none';

      // Update UI after request
      updateAlgorithmUI();

      // Check if operation was successful (status 200)
      if (event.detail.xhr.status === 200) {
        const responseText = event.detail.xhr.responseText;
        // If page refresh is triggered, the UI will update automatically
        if (responseText.includes('HX-Refresh') || responseText.includes('proceed to Step 4')) {
          // Page will refresh, no need to update button text
        } else {
          // Update button text based on current algorithm selection
          updateAlgorithmUI();
        }
      }
    });
  }

  // Step 4: Finalise Project - Unified button with advanced options
  const finaliseProjectBtn = document.getElementById('finalise-project-btn');
  const advancedOptionsToggle = document.getElementById('advanced-options-toggle');
  const finaliseStatus = document.getElementById('finalise-status');
  const finaliseConfirmDialog = document.getElementById('finalise-confirm-dialog');
  const finaliseConfirmMessage = document.getElementById('finalise-confirm-message');
  const finaliseConfirmBtn = document.getElementById('finalise-confirm-btn');
  const finaliseCancelBtn = document.getElementById('finalise-cancel-btn');
  const credentialsModal = document.getElementById('credentials-modal');
  const cancelCredsBtn = document.getElementById('cancel-creds-btn');
  const testCredsBtn = document.getElementById('test-creds-btn');
  const saveCredsBtn = document.getElementById('save-creds-btn');
  const credentialsForm = document.getElementById('credentials-form');
  const credentialsError = document.getElementById('credentials-error');
  const credentialsModalTitle = document.getElementById('credentials-modal-title');
  const odkCredentialsFields = document.getElementById('odk-credentials-fields');
  const qfieldCredentialsFields = document.getElementById('qfield-credentials-fields');

  // Determine project type
  const projectType = {% if field_mapping_app_value %}"{{ field_mapping_app_value|e }}"{% else %}null{% endif %};

  const isOdk = projectType === 'ODK';
  const isQField = projectType === 'QField';
  let customCreds = null;

  function getProjectTypeName() {
    if (isOdk) return 'ODK Central';
    if (isQField) return 'QField';
    return 'the mapping tool';
  }

  function showFinaliseConfirmDialog() {
    if (!isOdk && !isQField) {
      if (finaliseStatus) {
        finaliseStatus.innerHTML = (
          '<wa-callout variant="danger"><span>'
          + 'Project type not set. Please set the field mapping app first.'
          + '</span></wa-callout>'
        );
      }
      return;
    }

    const projectTypeName = getProjectTypeName();
    if (finaliseConfirmMessage) {
      finaliseConfirmMessage.textContent = (
        `Are you sure you want to finalise this project in ${projectTypeName}? `
        + 'This will create the project, upload forms, and generate all necessary files.'
      );
    }

    if (!finaliseConfirmDialog) {
      submitFinaliseProject();
      return;
    }

    if (typeof finaliseConfirmDialog.show === 'function') {
      finaliseConfirmDialog.show();
    } else {
      finaliseConfirmDialog.setAttribute('open', '');
    }
  }

  function hideFinaliseConfirmDialog() {
    if (!finaliseConfirmDialog) return;

    if (typeof finaliseConfirmDialog.hide === 'function') {
      finaliseConfirmDialog.hide();
    } else {
      finaliseConfirmDialog.removeAttribute('open');
    }
  }

  // Helper function to show error message
  function showError(message, variant = 'danger') {
    if (credentialsError) {
      credentialsError.innerHTML = `<wa-callout variant="${variant}"><span>${message}</span></wa-callout>`;
    }
  }

  // Helper function to get current credentials
  function getCredentials() {
    if (isOdk) {
      return {
        url: document.getElementById('odk-url-input')?.value?.trim(),
        username: document.getElementById('odk-username-input')?.value?.trim(),
        password: document.getElementById('odk-password-input')?.value?.trim()
      };
    } else if (isQField) {
      return {
        url: document.getElementById('qfield-url-input')?.value?.trim(),
        username: document.getElementById('qfield-username-input')?.value?.trim(),
        password: document.getElementById('qfield-password-input')?.value?.trim()
      };
    }
    return null;
  }

  // Helper function to reset modal
  function resetModal() {
    if (credentialsModal) credentialsModal.classList.remove('ftm-modal-backdrop--visible');
    if (credentialsForm) credentialsForm.reset();
    if (credentialsError) credentialsError.innerHTML = '';
    customCreds = null;
  }

  // Open credentials modal
  if (advancedOptionsToggle && credentialsModal) {
    advancedOptionsToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      // Check if project type is set
      if (!isOdk && !isQField) {
        showError('Project type not set. Please set the field mapping app first.', 'warning');
        credentialsModal.classList.add('ftm-modal-backdrop--visible');
        return;
      }

      // Configure modal based on project type
      if (isOdk) {
        credentialsModalTitle.textContent = 'Custom ODK Credentials';
        if (odkCredentialsFields) odkCredentialsFields.style.display = 'block';
        if (qfieldCredentialsFields) qfieldCredentialsFields.style.display = 'none';
      } else if (isQField) {
        credentialsModalTitle.textContent = 'Custom QField Credentials';
        if (odkCredentialsFields) odkCredentialsFields.style.display = 'none';
        if (qfieldCredentialsFields) qfieldCredentialsFields.style.display = 'block';
      }

      credentialsModal.classList.add('ftm-modal-backdrop--visible');
    });
  }

  // Close modal when clicking outside
  if (credentialsModal) {
    credentialsModal.addEventListener('click', function(e) {
      if (e.target === credentialsModal) {
        resetModal();
      }
    });
  }

  // Cancel button
  if (cancelCredsBtn) {
    cancelCredsBtn.addEventListener('click', resetModal);
  }

  // Test credentials
  if (testCredsBtn) {
    testCredsBtn.addEventListener('click', async function() {
      const creds = getCredentials();

      if (!creds || !creds.url || !creds.username || !creds.password) {
        showError('Please fill in all fields.', 'danger');
        return;
      }

      try {
        testCredsBtn.disabled = true;
        testCredsBtn.textContent = 'Testing...';
        showError('Testing credentials...', 'info');

        let response;

        if (isOdk) {
          const params = new URLSearchParams({
            external_project_instance_url: creds.url,
            external_project_username: creds.username,
            external_project_password: creds.password
          });
          response = await fetch(`/central/test-credentials?${params}`, {
            method: 'POST'
          });
        } else if (isQField) {
          response = await fetch('/qfield/test-credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              qfield_cloud_url: creds.url,
              qfield_cloud_user: creds.username,
              qfield_cloud_password: creds.password
            })
          });
        }

        if (response.ok) {
          showError('âœ“ Credentials are valid!', 'success');
          customCreds = creds;
        } else {
          const error = await response.json();
          showError(error.detail || 'Invalid credentials. Please check and try again.', 'danger');
          customCreds = null;
        }
      } catch (error) {
        showError(`Error testing credentials: ${error.message}`, 'danger');
        customCreds = null;
      } finally {
        testCredsBtn.disabled = false;
        testCredsBtn.textContent = 'Test Credentials';
      }
    });
  }

  // Save credentials and proceed
  if (saveCredsBtn && credentialsForm) {
    credentialsForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!customCreds) {
        showError('Please test credentials first before continuing.', 'warning');
        return;
      }

      credentialsModal.classList.remove('ftm-modal-backdrop--visible');

      // Ask for confirmation before finalising with saved custom credentials.
      showFinaliseConfirmDialog();
    });
  }

      // Finalise Project (unified submit function)
      async function submitFinaliseProject() {
        const projectTypeName = getProjectTypeName();
        try {
          finaliseStatus.innerHTML = `<wa-callout variant="info"><span>Creating project in ${projectTypeName}... This may take a moment.</span></wa-callout>`;
          if (finaliseProjectBtn) finaliseProjectBtn.disabled = true;
          if (advancedOptionsToggle) advancedOptionsToggle.disabled = true;
          if (finaliseConfirmBtn) finaliseConfirmBtn.disabled = true;
          if (finaliseCancelBtn) finaliseCancelBtn.disabled = true;

          const formData = new FormData();
          if (customCreds) {
            if (isOdk) {
              formData.append('external_project_instance_url', customCreds.url);
              formData.append('external_project_username', customCreds.username);
              formData.append('external_project_password', customCreds.password);
            } else if (isQField) {
              formData.append('qfield_cloud_url', customCreds.url);
              formData.append('qfield_cloud_user', customCreds.username);
              formData.append('qfield_cloud_password', customCreds.password);
            }
          }

          let endpoint;
          if (isOdk) {
            endpoint = `/create-project-odk-htmx?project_id=${projectId}`;
          } else if (isQField) {
            endpoint = `/create-project-qfield-htmx?project_id=${projectId}`;
          } else {
            finaliseStatus.innerHTML = '<wa-callout variant="danger"><span>Project type not set. Please set the field mapping app first.</span></wa-callout>';
            if (finaliseProjectBtn) finaliseProjectBtn.disabled = false;
            if (advancedOptionsToggle) advancedOptionsToggle.disabled = false;
            return;
          }

          const response = await fetch(endpoint, {
            method: 'POST',
            body: formData
          });

          const result = await response.text();
          finaliseStatus.innerHTML = result;

          if (response.ok) {
            if (finaliseProjectBtn) finaliseProjectBtn.disabled = false;
            if (advancedOptionsToggle) advancedOptionsToggle.disabled = false;
          } else {
            if (finaliseProjectBtn) finaliseProjectBtn.disabled = false;
            if (advancedOptionsToggle) advancedOptionsToggle.disabled = false;
          }
        } catch (error) {
          finaliseStatus.innerHTML = `<wa-callout variant="danger"><span>Error: ${error.message}</span></wa-callout>`;
          if (finaliseProjectBtn) finaliseProjectBtn.disabled = false;
          if (advancedOptionsToggle) advancedOptionsToggle.disabled = false;
        } finally {
          if (finaliseConfirmBtn) finaliseConfirmBtn.disabled = false;
          if (finaliseCancelBtn) finaliseCancelBtn.disabled = false;
        }
      }

      // Finalise confirmation controls
      if (finaliseCancelBtn) {
        finaliseCancelBtn.addEventListener('click', function() {
          hideFinaliseConfirmDialog();
        });
      }

      if (finaliseConfirmBtn) {
        finaliseConfirmBtn.addEventListener('click', function() {
          hideFinaliseConfirmDialog();
          submitFinaliseProject();
        });
      }

      // Finalise Project button
      if (finaliseProjectBtn) {
        finaliseProjectBtn.addEventListener('click', function() {
          // Use default credentials (server bundled) if no custom credentials set
          showFinaliseConfirmDialog();
        });
      }

      // NOTE: We intentionally do not auto-load Leaflet previews on page load.
      // This keeps Step 2 "completed" state collapsed (no reserved space for the map).
    })();
</script>
