<!-- Project setup flow and published mapper access -->
{% set status_value = project.status.value if project.status and
project.status.value else (project.status if project.status is string else
'DRAFT') %} {% set has_xlsform = project.xlsform_content is not none and
project.xlsform_content %} {% set has_data_extract =
project.data_extract_geojson is not none and project.data_extract_geojson %} {%
set is_empty_data_extract = project.data_extract_geojson == {} %} {% set
has_task_areas = project.task_areas_geojson is not none %} {% set
is_no_splitting = project.task_areas_geojson == {} %} {% if status_value ==
'PUBLISHED' %}
<!-- Project Published - Mapper-first access -->
<div class="ftm-published-divider ftm-published-divider--top">
  <h2 class="ftm-published-header">Ready for Mapping</h2>

  <div class="ftm-qr-hero">
    <div
      id="qrcode-container"
      class="ftm-qr-hero__container"
      hx-get="/project-qrcode-htmx?project_id={% if project %}{{ project.id }}{% endif %}"
      hx-trigger="load"
      hx-swap="innerHTML"
    >
      <div class="ftm-qr-hero__loading">
        <p style="color: #666">Loading QR code...</p>
      </div>
    </div>
  </div>
</div>
{% elif status_value == 'DRAFT' %}
<div class="ftm-published-divider">
  <h2 class="ftm-setup-header">Project Setup</h2>

  <!-- Step 1: Select XLSForm (always show, with completion indicator) -->
  <div
    id="step-1-container"
    class="ftm-step {% if has_xlsform %}ftm-step--complete{% else %}ftm-step--pending{% endif %}"
  >
    <div class="ftm-step__header">
      <h3 class="ftm-step__title">
        Step 1: Select Survey Form {% if has_xlsform %}
        <span class="ftm-step__check">✓</span>
        {% endif %}
      </h3>
      {% if has_xlsform %}
      <wa-badge variant="success">Complete</wa-badge>
      {% endif %}
    </div>
    {% if not has_xlsform %}
    <p class="ftm-step__description">
      Choose a category type from existing XLSForms or upload a custom form.
    </p>
    <div class="ftm-step__actions">
      <wa-button
        id="select-xlsform-btn"
        variant="default"
        style="flex: 1; min-width: 200px"
      >
        Select Category Type
      </wa-button>
      <wa-button
        id="upload-xlsform-btn"
        variant="default"
        style="flex: 1; min-width: 200px"
      >
        Upload Custom Form
      </wa-button>
    </div>

    <!-- Form Configuration Options (shown after form selection/upload) -->
    <div id="form-config-container" class="ftm-form-config">
      <h4 style="color: #333; margin-bottom: 15px; font-size: 1.1em">
        Form Configuration
      </h4>
      <form
        id="upload-xlsform-form"
        hx-post="/upload-xlsform-htmx?project_id={% if project %}{{ project.id }}{% endif %}"
        hx-target="#xlsform-status"
        hx-swap="innerHTML"
        hx-encoding="multipart/form-data"
        style="display: flex; flex-direction: column; gap: 12px"
      >
        <label
          class="ftm-checkbox-label"
          style="display: flex; align-items: center; gap: 8px"
        >
          <input
            type="checkbox"
            name="need_verification_fields"
            value="true"
            checked
            style="margin: 0; cursor: pointer"
          />
          <span style="font-size: 0.95em">Include verification fields</span>
        </label>
        <label
          class="ftm-checkbox-label"
          style="display: flex; align-items: center; gap: 8px"
        >
          <input
            type="checkbox"
            name="mandatory_photo_upload"
            value="true"
            style="margin: 0; cursor: pointer"
          />
          <span style="font-size: 0.95em">Make photo upload mandatory</span>
        </label>
        {% if field_mapping_app_value %} {% set app_name =
        field_mapping_app_value %} {% set is_odk = field_mapping_app_upper ==
        'ODK' %}
        <input
          type="hidden"
          name="use_odk_collect"
          value="{{ 'true' if is_odk else 'false' }}"
        />
        {% if is_odk %}
        <div class="ftm-config-note ftm-config-note--info">
          <span
            >✓ ODK Collect-specific components will be included (automatically
            set for ODK projects)</span
          >
        </div>
        {% else %}
        <div class="ftm-config-note ftm-config-note--muted">
          <span
            >ODK Collect-specific components disabled (project uses {{ app_name
            }})</span
          >
        </div>
        {% endif %} {% else %}
        <input type="hidden" name="use_odk_collect" value="false" />
        <div class="ftm-config-note ftm-config-note--muted">
          <span
            >ODK Collect-specific components disabled (no field mapping app
            selected)</span
          >
        </div>
        {% endif %}
        <div style="margin-top: 10px">
          <label class="ftm-split-label">Default Language:</label>
          <select name="default_language" class="ftm-split-select">
            <option value="english">English</option>
            <option value="spanish">Spanish</option>
            <option value="french">French</option>
            <option value="portuguese">Portuguese</option>
            <option value="swahili">Swahili</option>
            <option value="hindi">Hindi</option>
          </select>
        </div>
        <input
          type="file"
          name="xlsform"
          id="xlsform-file-input"
          accept=".xls,.xlsx"
          style="display: none"
        />
        <input
          type="hidden"
          name="template_form_id"
          id="template-form-id"
          value=""
        />
        <wa-button type="submit" variant="primary" style="margin-top: 10px">
          Apply Configuration & Upload
        </wa-button>
      </form>
    </div>

    <div id="xlsform-status" class="ftm-step__status"></div>
    {% else %}
    <div class="ftm-step__success">✓ Survey form uploaded successfully</div>
    {% endif %}
  </div>

  <!-- Step 2: Download/Upload OSM Data (always show if Step 1 is complete) -->
  {% if has_xlsform %}
  <div
    id="step-2-container"
    class="ftm-step {% if has_data_extract %}ftm-step--complete{% else %}ftm-step--pending{% endif %}"
  >
    <div class="ftm-step__header">
      <h3 class="ftm-step__title">
        Step 2: Get Data {% if has_data_extract %}
        <span class="ftm-step__check">✓</span>
        {% endif %}
      </h3>
      {% if has_data_extract %}
      <wa-badge variant="success">Complete</wa-badge>
      {% endif %}
    </div>
    {% if not has_data_extract %}
    <p class="ftm-step__description">
      Download OSM data for the selected category or upload a custom GeoJSON
      file. Review the data on the map, then continue to the next step.
    </p>
    <div class="ftm-step__actions">
      <button
        id="download-osm-data-btn"
        hx-post="/download-osm-data-htmx?project_id={% if project %}{{ project.id }}{% endif %}&osm_category=buildings&geom_type=POLYGON"
        hx-target="#osm-data-status"
        hx-swap="innerHTML"
        hx-indicator="#download-spinner"
        class="wa-button wa-button--default"
        style="flex: 1; min-width: 200px; position: relative"
      >
        <span id="download-btn-text">Download OSM Data</span>
        <span
          id="download-spinner"
          class="htmx-indicator"
          style="display: none; margin-left: 8px"
        >
          <svg
            class="ftm-spinner"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 12a9 9 0 11-6.219-8.56" />
          </svg>
        </span>
      </button>
      <button
        id="upload-geojson-btn"
        class="wa-button wa-button--default"
        style="flex: 1; min-width: 200px"
      >
        Upload Custom GeoJSON
      </button>
    </div>
    <div id="osm-data-status" class="ftm-step__status">
      <div id="download-loading" class="htmx-indicator ftm-loading">
        <div style="display: inline-block">
          <svg
            class="ftm-spinner ftm-spinner--lg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 12a9 9 0 11-6.219-8.56" />
          </svg>
          <p style="margin-top: 10px; color: #666">
            Generating OSM data extract... This may take a moment.
          </p>
        </div>
      </div>
    </div>
    <form
      id="upload-geojson-form"
      method="POST"
      enctype="multipart/form-data"
      hx-post="/upload-geojson-htmx?project_id={% if project %}{{ project.id }}{% endif %}"
      hx-target="#osm-data-status"
      hx-swap="innerHTML"
      hx-encoding="multipart/form-data"
      style="display: none"
    >
      <input
        type="file"
        name="data"
        id="geojson-file-input"
        accept=".geojson,.json"
        required
      />
    </form>
    <div id="geojson-preview-container" style="margin-top: 15px"></div>
    {% else %}
    <div class="ftm-step__success">✓ OSM data extract ready</div>
    <div class="ftm-step__actions" style="margin-top: 10px; margin-bottom: 0">
      <button
        id="preview-data-extract-btn"
        hx-get="/preview-geojson-htmx?project_id={% if project %}{{ project.id }}{% endif %}"
        hx-target="#geojson-preview-container"
        hx-swap="innerHTML"
        class="wa-button wa-button--default"
        type="button"
      >
        Preview Data Extract
      </button>
      <button
        id="hide-data-extract-preview-btn"
        class="wa-button wa-button--default"
        type="button"
        style="display: none"
      >
        Hide Preview
      </button>
    </div>
    <div id="geojson-preview-wrapper" style="display: none; margin-top: 15px">
      <div id="geojson-preview-container"></div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Step 3: Split AOI (only show if Step 2 is complete, including empty data extract) -->
  {% if has_data_extract or (project.data_extract_geojson is not none and
  is_empty_data_extract) %}
  <div
    id="step-3-container"
    class="ftm-step {% if has_task_areas %}ftm-step--complete{% else %}ftm-step--pending{% endif %}"
  >
    <div class="ftm-step__header">
      <h3 class="ftm-step__title">
        Step 3: Split into Tasks (Optional) {% if has_task_areas %}
        <span class="ftm-step__check">✓</span>
        {% endif %}
      </h3>
      {% if has_task_areas %}
      <wa-badge variant="success">Complete</wa-badge>
      {% endif %}
    </div>
    {% if has_task_areas %} {% if is_empty_data_extract and is_no_splitting %}
    <div class="ftm-step__success">
      ✓ Task splitting is not relevant without existing data
    </div>
    {% else %}
    <div class="ftm-step__success">✓ Split tasks saved successfully</div>
    {% endif %} {% else %}
    <p class="ftm-step__description">
      Generate task areas by splitting the Area of Interest (AOI). Choose an
      algorithm and parameters, then split. Review the preview, and click
      "Accept Task Choices" to save.
    </p>
    <form
      id="split-aoi-form"
      hx-post="/split-aoi-htmx?project_id={% if project %}{{ project.id }}{% endif %}"
      hx-target="#split-status"
      hx-swap="innerHTML"
      hx-indicator="#split-loading"
      style="margin-bottom: 15px"
    >
      <div class="ftm-split-grid">
        <div>
          <label for="split-algorithm" class="ftm-split-label"
            >Algorithm:</label
          >
          <select
            id="split-algorithm"
            name="algorithm"
            required
            class="ftm-split-select"
          >
            <option
              value=""
              disabled
              {%
              if
              not
              has_task_areas
              or
              (has_task_areas
              and
              not
              is_no_splitting)
              %}selected{%
              endif
              %}
            >
              Select splitting option...
            </option>
            <option
              value="NO_SPLITTING"
              {%
              if
              is_no_splitting
              %}selected{%
              endif
              %}
            >
              No Splitting (Use Whole AOI)
            </option>
            <option value="DIVIDE_BY_SQUARE">Split by Square</option>
            <option value="AVG_BUILDING_VORONOI">
              Average Buildings v1 (Voronoi)
            </option>
            <option value="AVG_BUILDING_SKELETON">
              Average Buildings v2 (Straight Skeleton)
            </option>
            <option value="TOTAL_TASKS" disabled>
              Split by Specific Number of Tasks (Coming Soon)
            </option>
          </select>
        </div>
        <div id="algorithm-param-container">
          <!-- Dynamic parameter field based on algorithm selection -->
          <div id="param-buildings" style="display: none">
            <label for="no-of-buildings" class="ftm-split-label"
              >Avg. Buildings per Task:</label
            >
            <input
              type="number"
              id="no-of-buildings"
              name="no_of_buildings"
              value="50"
              min="1"
              class="ftm-split-input"
            />
          </div>
          <div id="param-dimension" style="display: none">
            <label for="dimension-meters" class="ftm-split-label"
              >Dimension (meters):</label
            >
            <input
              type="number"
              id="dimension-meters"
              name="dimension_meters"
              value="100"
              min="10"
              class="ftm-split-input"
            />
          </div>
        </div>
        <div class="ftm-split-submit">
          <button
            type="submit"
            class="wa-button wa-button--primary"
            style="width: 100%; position: relative"
          >
            <span id="split-btn-text"
              >{% if has_task_areas %}Split Again{% else %}Split AOI{% endif
              %}</span
            >
            <span
              id="split-btn-spinner"
              class="htmx-indicator"
              style="display: none; margin-left: 8px"
            >
              <svg
                class="ftm-spinner"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 12a9 9 0 11-6.219-8.56" />
              </svg>
            </span>
          </button>
        </div>
      </div>
    </form>
    {% endif %} {% if not has_task_areas %}
    <div id="split-status" class="ftm-step__status">
      <div id="split-loading" class="htmx-indicator ftm-loading">
        <div style="display: inline-block">
          <svg
            class="ftm-spinner ftm-spinner--lg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 12a9 9 0 11-6.219-8.56" />
          </svg>
          <p style="margin-top: 10px; color: #666">
            Splitting AOI into tasks... This may take a moment.
          </p>
        </div>
      </div>
    </div>
    {% endif %} {% if not has_task_areas %}
    <div id="tasks-and-data-preview-container" style="margin-top: 15px"></div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Step 4: Finalise Project (only show if Steps 1, 2, and 3 are complete) -->
  {% if has_xlsform and has_data_extract and has_task_areas %}
  <div id="step-4-container" class="ftm-step ftm-step--complete">
    <div class="ftm-step__header">
      <h3 class="ftm-step__title">Step 4: Finalise Project</h3>
      <wa-badge variant="success">Ready</wa-badge>
    </div>
    <p class="ftm-step__description">
      All prerequisites are complete! Create the project in your chosen mapping
      tool.
    </p>

    <div class="ftm-step__actions">
      <wa-button
        id="finalise-project-btn"
        variant="primary"
        style="min-width: 200px"
      >
        Finalise Project
      </wa-button>
      <wa-button
        id="advanced-options-toggle"
        variant="default"
        style="min-width: 200px"
      >
        Advanced Options
      </wa-button>
    </div>

    <div id="finalise-status" class="ftm-step__status"></div>

    <!-- Finalise Confirmation Dialog -->
    <wa-dialog
      id="finalise-confirm-dialog"
      label="Confirm Project Finalisation"
      with-header
    >
      <p
        id="finalise-confirm-message"
        style="margin: 0; line-height: 1.6; color: #444"
      >
        Are you sure you want to finalise this project?
      </p>
      <div slot="footer" class="ftm-flex-end">
        <wa-button id="finalise-cancel-btn" variant="default">Cancel</wa-button>
        <wa-button id="finalise-confirm-btn" variant="primary">
          Confirm & Finalise
        </wa-button>
      </div>
    </wa-dialog>

    <!-- Credentials Modal (for ODK or QField) -->
    <div id="credentials-modal" class="ftm-modal-backdrop">
      <div class="ftm-modal">
        <h3 id="credentials-modal-title" class="ftm-modal__title">
          Custom Credentials
        </h3>
        <form
          id="credentials-form"
          style="display: flex; flex-direction: column; gap: 15px"
        >
          <!-- ODK Credentials Fields -->
          <div id="odk-credentials-fields" style="display: none">
            <div>
              <label class="ftm-split-label">
                ODK Central URL <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="url"
                id="odk-url-input"
                name="external_project_instance_url"
                placeholder="https://your-odk-central.com"
                style="width: 100%"
              ></wa-input>
            </div>
            <div>
              <label class="ftm-split-label">
                Username <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="text"
                id="odk-username-input"
                name="external_project_username"
                placeholder="Username"
                style="width: 100%"
              ></wa-input>
            </div>
            <div>
              <label class="ftm-split-label">
                Password <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="password"
                id="odk-password-input"
                name="external_project_password"
                placeholder="Password"
                style="width: 100%"
              ></wa-input>
            </div>
          </div>

          <!-- QField Credentials Fields -->
          <div id="qfield-credentials-fields" style="display: none">
            <div>
              <label class="ftm-split-label">
                QField Cloud URL <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="url"
                id="qfield-url-input"
                name="qfield_cloud_url"
                placeholder="https://qfield.cloud"
                style="width: 100%"
              ></wa-input>
            </div>
            <div>
              <label class="ftm-split-label">
                Username <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="text"
                id="qfield-username-input"
                name="qfield_cloud_user"
                placeholder="qfield_username"
                style="width: 100%"
              ></wa-input>
            </div>
            <div>
              <label class="ftm-split-label">
                Password <span class="ftm-form-required">*</span>
              </label>
              <wa-input
                type="password"
                id="qfield-password-input"
                name="qfield_cloud_password"
                placeholder="qfield_password"
                style="width: 100%"
              ></wa-input>
            </div>
          </div>

          <div id="credentials-error" style="margin-top: 10px"></div>
          <div class="ftm-modal__footer">
            <wa-button type="button" id="cancel-creds-btn" variant="default">
              Cancel
            </wa-button>
            <wa-button type="button" id="test-creds-btn" variant="default">
              Test Credentials
            </wa-button>
            <wa-button type="submit" id="save-creds-btn" variant="primary">
              Save & Continue
            </wa-button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endif %}
